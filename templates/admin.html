<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PhishX</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="{{ url_for('dashboard') }}" class="sidebar-logo">
                    <div class="sidebar-logo-icon">PX</div>
                    <div class="sidebar-logo-text">PhishX</div>
                </a>
            </div>
            
            <div class="sidebar-user">
                <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
                <div>
                    <div>{{ current_user.username }}</div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">Administrator</div>
                </div>
            </div>
            
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('dashboard') }}" class="sidebar-nav-link">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('email_analysis') }}" class="sidebar-nav-link">
                        <i class="fas fa-envelope"></i>
                        <span>Email Analysis</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('reports') }}" class="sidebar-nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('training') }}" class="sidebar-nav-link">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Training</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('profile') }}" class="sidebar-nav-link">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('settings') }}" class="sidebar-nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('admin') }}" class="sidebar-nav-link active">
                        <i class="fas fa-user-shield"></i>
                        <span>Admin Panel</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="{{ url_for('logout') }}" class="sidebar-nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Admin Panel</h1>
                    <div class="breadcrumb">
                        <a href="{{ url_for('dashboard') }}">Home</a>
                        <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
                        <span>Admin Panel</span>
                    </div>
                </div>
                <div>
                    <button class="btn btn-primary">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
            </div>
            
            <!-- Admin Tabs -->
            <div class="admin-tabs">
                <div class="admin-tab active" data-tab="overview">Overview</div>
                <div class="admin-tab" data-tab="users">Users</div>
                <div class="admin-tab" data-tab="analyses">Email Analyses</div>
                <div class="admin-tab" data-tab="settings">Settings</div>
            </div>
            
            <!-- Admin Content -->
            <div class="admin-content">
                <!-- Overview Tab -->
                <div class="admin-tab-content" id="overview-tab" style="display: block;">
                    <h2 style="margin-bottom: 1.5rem;">System Overview</h2>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card-dashboard">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Total Users</div>
                                <div class="stat-card-icon" style="background: #eef2ff; color: var(--primary);">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-card-value">{{ users|length }}</div>
                            <div class="stat-card-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>8% from last week</span>
                            </div>
                        </div>
                        
                        <div class="stat-card-dashboard">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Total Analyses</div>
                                <div class="stat-card-icon" style="background: #fee2e2; color: var(--danger);">
                                    <i class="fas fa-envelope-open-text"></i>
                                </div>
                            </div>
                            <div class="stat-card-value">{{ analyses|length }}</div>
                            <div class="stat-card-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>15% from last week</span>
                            </div>
                        </div>
                        
                        <div class="stat-card-dashboard">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Phishing Detected</div>
                                <div class="stat-card-icon" style="background: #fef3c7; color: var(--accent);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value">{{ analyses|selectattr('classification', 'equalto', 'Phishing')|list|length }}</div>
                            <div class="stat-card-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span>3% from last week</span>
                            </div>
                        </div>
                        
                        <div class="stat-card-dashboard">
                            <div class="stat-card-header">
                                <div class="stat-card-title">System Health</div>
                                <div class="stat-card-icon" style="background: #dcfce7; color: var(--secondary);">
                                    <i class="fas fa-heartbeat"></i>
                                </div>
                            </div>
                            <div class="stat-card-value">98.5%</div>
                            <div class="stat-card-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span>1.2% from last week</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Recent Activity</h3>
                        <div class="analyses-list">
                            {% for analysis in analyses[:5] %}
                                <div class="analysis-item">
                                    <div class="analysis-item-header">
                                        <div class="analysis-item-title">{{ analysis.user.username }} analyzed {{ analysis.filename }}</div>
                                        <div class="analysis-item-date">{{ analysis.uploaded_at.strftime('%b %d, %Y at %I:%M %p') }}</div>
                                    </div>
                                    <div class="analysis-item-content">
                                        <div class="analysis-item-risk">
                                            <div class="risk-score-display">{{ analysis.risk_score }}%</div>
                                            <div class="risk-badge {{ 'high' if analysis.risk_score > 70 else 'medium' if analysis.risk_score > 40 else 'low' }}">
                                                {{ 'High Risk' if analysis.risk_score > 70 else 'Medium Risk' if analysis.risk_score > 40 else 'Low Risk' }}
                                            </div>
                                            <div class="classification-badge {{ 'badge-phishing' if analysis.classification == 'Phishing' else 'badge-safe' }}">
                                                {{ analysis.classification }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- Users Tab -->
                <div class="admin-tab-content" id="users-tab" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Users Management</h2>
                        <button class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Analyses</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">{{ user.username[0].upper() }}</div>
                                                {{ user.username }}
                                            </div>
                                        </td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            <span class="badge {{ 'badge-admin' if user.is_admin else 'badge-user' }}">
                                                {{ 'Administrator' if user.is_admin else 'User' }}
                                            </span>
                                        </td>
                                        <td>{{ user.analyses|length }}</td>
                                        <td>{{ user.created_at.strftime('%b %d, %Y') }}</td>
                                        <td>
                                            <span class="badge badge-safe">Active</span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="action-btn" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="action-btn" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Analyses Tab -->
                <div class="admin-tab-content" id="analyses-tab" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2>Email Analyses</h2>
                        <div>
                            <button class="btn btn-outline" style="margin-right: 0.5rem;" onclick="applyAdminFilter()">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <button class="btn btn-primary" onclick="exportAdminData()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Filename</th>
                                    <th>Risk Score</th>
                                    <th>Classification</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for analysis in analyses %}
                                    <tr>
                                        <td>{{ analysis.id }}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <div class="user-avatar" style="width: 30px; height: 30px; font-size: 0.8rem;">{{ analysis.user.username[0].upper() }}</div>
                                                {{ analysis.user.username }}
                                            </div>
                                        </td>
                                        <td>{{ analysis.filename }}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                {% if analysis.risk_score > 70 %}
                                                    <div style="width: 40px; height: 4px; background: #ef4444; border-radius: 2px;"></div>
                                                {% elif analysis.risk_score > 40 %}
                                                    <div style="width: 40px; height: 4px; background: #f59e0b; border-radius: 2px;"></div>
                                                {% else %}
                                                    <div style="width: 40px; height: 4px; background: #10b981; border-radius: 2px;"></div>
                                                {% endif %}
                                                {{ analysis.risk_score }}%
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge {{ 'badge-phishing' if analysis.classification == 'Phishing' else 'badge-safe' }}">
                                                {{ analysis.classification }}
                                            </span>
                                        </td>
                                        <td>{{ analysis.uploaded_at.strftime('%b %d, %Y') }}</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <a href="{{ url_for('view_analysis', analysis_id=analysis.id) }}" class="action-btn" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('export_report', analysis_id=analysis.id) }}" class="action-btn" title="Download Report">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('delete_analysis', analysis_id=analysis.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this analysis?');">
                                                    <button type="submit" class="action-btn" title="Delete" style="border: none; background: none; cursor: pointer;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="admin-tab-content" id="settings-tab" style="display: none;">
                    <h2>System Settings</h2>
                    <p>Settings management would be implemented here.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching functionality
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.admin-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Hide all tab contents
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Show corresponding tab content
                const tabName = tab.getAttribute('data-tab');
                document.getElementById(`${tabName}-tab`).style.display = 'block';
            });
        });
        
        function applyAdminFilter() {
            // Show filter options
            const filterType = prompt('Enter filter type (user, classification):', 'classification');
            if (filterType) {
                const filterValue = prompt(`Enter filter value for ${filterType} (e.g., Phishing, Legitimate):`, '');
                if (filterValue) {
                    // Get table rows in the analyses tab
                    const tableRows = document.querySelectorAll('#analyses-tab .admin-table tbody tr');
                    
                    // Filter rows based on criteria
                    tableRows.forEach(row => {
                        let showRow = true;
                        
                        if (filterType === 'user') {
                            const userCell = row.cells[1]; // User column
                            const userText = userCell.textContent.toLowerCase();
                            if (!userText.includes(filterValue.toLowerCase())) {
                                showRow = false;
                            }
                        } else if (filterType === 'classification') {
                            const classificationCell = row.cells[4]; // Classification column
                            const classificationText = classificationCell.textContent.trim();
                            if (classificationText !== filterValue) {
                                showRow = false;
                            }
                        }
                        
                        // Show or hide row based on filters
                        row.style.display = showRow ? '' : 'none';
                    });
                    
                    alert(`Filter applied:\nType: ${filterType}\nValue: ${filterValue}`);
                }
            }
        }
        
        function exportAdminData() {
            // Redirect to the CSV export endpoint which exports all user's analyses
            window.location.href = '/export_csv';
        }
    </script>
</body>
</html>
